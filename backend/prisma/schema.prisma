// Prisma Schema - Flutter My Assets API
// MySQL 8+ | Mauricio Durán - IntegralTech Services SpA

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// Región y Comuna (Chile)
// -----------------------------------------------------------------------------

model Region {
  id      String   @id @default(uuid())
  nombre  String   @unique
  comunas Comuna[]
  users   User[]

  @@map("regions")
}

model Comuna {
  id       String   @id @default(uuid())
  nombre   String
  regionId String   @map("region_id")
  region   Region   @relation(fields: [regionId], references: [id], onDelete: Cascade)
  users    User[]

  @@unique([nombre, regionId])
  @@index([regionId])
  @@map("comunas")
}

// -----------------------------------------------------------------------------
// Usuarios y autenticación
// -----------------------------------------------------------------------------

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String    @map("password_hash")
  role            String    @default("USER") // USER | ADMIN
  // Perfil ampliado
  nombres         String    @map("nombres")
  apellidos       String    @map("apellidos")
  sexo            String    // HOMBRE | MUJER | OTRO
  fechaNacimiento DateTime  @map("fecha_nacimiento") @db.Date
  domicilio       String?   @map("domicilio")
  regionId        String?   @map("region_id")
  comunaId        String?   @map("comuna_id")
  avatarUrl       String?   @map("avatar_url") // URL de foto de perfil (ej. /uploads/users/xxx.jpg)
  //
  emailVerifiedAt DateTime? @map("email_verified_at")
  termsAcceptedAt DateTime? @map("terms_accepted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at") // soft delete

  region   Region?   @relation(fields: [regionId], references: [id], onDelete: SetNull)
  comuna   Comuna?   @relation(fields: [comunaId], references: [id], onDelete: SetNull)
  refreshTokens         RefreshToken[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens   PasswordResetToken[]
  auditLogs             AuditLog[]
  properties            Property[]
  favorites             Favorite[]
  userTermsAcceptances  UserTermsAcceptance[]
  reviews               Review[]
  conversationsAsOwner  Conversation[] @relation("OwnerConversations")
  conversationsAsRenter Conversation[] @relation("RenterConversations")
  messages              Message[]
  notifications         Notification[]
  bookings              Booking[]

  @@index([regionId])
  @@index([comunaId])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

model EmailVerificationToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("email_verification_tokens")
}

model OtpCode {
  id        String   @id @default(uuid())
  email     String
  codeHash  String   @map("code_hash")
  purpose   String   // LOGIN | EMAIL_VERIFY | PASSWORD_RESET
  expiresAt DateTime @map("expires_at")
  attempts  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@index([email, purpose])
  @@map("otp_codes")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("password_reset_tokens")
}

// -----------------------------------------------------------------------------
// Propiedades (inmuebles)
// -----------------------------------------------------------------------------

model Property {
  id          String    @id @default(uuid())
  title       String
  description String?   @db.Text
  address     String?
  city        String?
  region      String?
  latitude    Decimal?  @map("latitude") @db.Decimal(10, 7)
  longitude   Decimal?  @map("longitude") @db.Decimal(10, 7)
  facilities  Json?     @map("facilities") // ["wifi","estacionamiento",...]
  bedrooms    Int?      @map("bedrooms")
  bathrooms   Int?      @map("bathrooms")
  price       Decimal?  @db.Decimal(14, 2)
  currency    String    @default("CLP")
  type        String?   // venta | arriendo | rent | sale
  status      String    @default("DRAFT") // DRAFT | PUBLISHED | ARCHIVED
  userId      String?   @map("user_id")
  ratingAvg   Decimal?  @map("rating_avg") @db.Decimal(3, 2) // 0.00-5.00; actualizable por job/trigger
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  user              User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  propertyImages    PropertyImage[]
  favorites         Favorite[]
  reviews           Review[]
  conversations     Conversation[]
  riskAssessments   RiskAssessment[]
  bookings          Booking[]

  @@index([userId])
  @@index([status])
  @@index([city])
  @@index([type])
  @@map("properties")
}

// -----------------------------------------------------------------------------
// Términos y condiciones (versiones)
// -----------------------------------------------------------------------------

model Term {
  id        String   @id @default(uuid())
  version   String   @unique // ej: "1.0"
  title     String
  content   String   @db.LongText
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")

  userTermsAcceptances UserTermsAcceptance[]

  @@map("terms")
}

// -----------------------------------------------------------------------------
// Auditoría (LOGIN, CREATE, UPDATE, DELETE, ACCEPT_TERMS)
// -----------------------------------------------------------------------------

model AuditLog {
  id         String   @id @default(uuid())
  action     String   // LOGIN | CREATE | UPDATE | DELETE | ACCEPT_TERMS | PUBLISH_PROPERTY | ARCHIVE_PROPERTY
  entity     String?  // User | Property | Term | Review | Message | Booking
  entityId   String?  @map("entity_id")
  userId     String?  @map("user_id")
  beforeJson Json?    @map("before_json")
  afterJson  Json?    @map("after_json")
  ip         String?
  userAgent  String?  @map("user_agent") @db.VarChar(500)
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([action])
  @@index([entity])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// -----------------------------------------------------------------------------
// Imágenes de propiedades
// -----------------------------------------------------------------------------

model PropertyImage {
  id         String   @id @default(uuid())
  propertyId String   @map("property_id")
  url        String   @db.VarChar(500)
  sortOrder  Int      @map("sort_order") @default(0)
  createdAt  DateTime @default(now()) @map("created_at")

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("property_images")
}

// -----------------------------------------------------------------------------
// Favoritos (usuario ↔ propiedad)
// -----------------------------------------------------------------------------

model Favorite {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  propertyId String   @map("property_id")
  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
  @@map("favorites")
}

// -----------------------------------------------------------------------------
// Trazabilidad de aceptación de términos por versión
// -----------------------------------------------------------------------------

model UserTermsAcceptance {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  termId      String   @map("term_id")
  termVersion String   @map("term_version") // snapshot ej. "1.0"
  acceptedAt  DateTime @map("accepted_at")
  ip          String?
  userAgent   String?  @map("user_agent") @db.VarChar(500)
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  term Term @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([termId])
  @@map("user_terms_acceptances")
}

// -----------------------------------------------------------------------------
// Reseñas de propiedades (promedio en properties.rating_avg vía job/trigger)
// -----------------------------------------------------------------------------

model Review {
  id         String   @id @default(uuid())
  propertyId String   @map("property_id")
  userId     String   @map("user_id")
  rating     Int      // ej. 1-5
  comment    String?  @db.Text
  mediaUrl   String?  @map("media_url") @db.VarChar(500)
  createdAt  DateTime @default(now()) @map("created_at")

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([userId])
  @@map("reviews")
}

// -----------------------------------------------------------------------------
// Conversaciones y mensajes (dueño ↔ interesado por propiedad)
// -----------------------------------------------------------------------------

model Conversation {
  id             String   @id @default(uuid())
  propertyId     String   @map("property_id")
  ownerUserId    String   @map("owner_user_id")
  renterUserId   String   @map("renter_user_id")
  createdAt      DateTime @default(now()) @map("created_at")

  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  ownerUser  User      @relation("OwnerConversations", fields: [ownerUserId], references: [id], onDelete: Cascade)
  renterUser User      @relation("RenterConversations", fields: [renterUserId], references: [id], onDelete: Cascade)
  messages   Message[]

  @@index([propertyId])
  @@index([ownerUserId])
  @@index([renterUserId])
  @@map("conversations")
}

model Message {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  senderUserId   String    @map("sender_user_id")
  body           String    @db.Text
  type           String    @default("text") // text | image
  createdAt      DateTime  @default(now()) @map("created_at")
  readAt         DateTime? @map("read_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderUser   User         @relation(fields: [senderUserId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderUserId])
  @@map("messages")
}

// -----------------------------------------------------------------------------
// Notificaciones (eventos: publicación activa, mensaje nuevo, etc.)
// -----------------------------------------------------------------------------

model Notification {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  type      String    // ej. PROPERTY_PUBLISHED | NEW_MESSAGE | ...
  title     String    @db.VarChar(255)
  body      String?   @db.Text
  dataJson  Json?     @map("data_json")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, readAt])
  @@map("notifications")
}

// -----------------------------------------------------------------------------
// Valoración de riesgo por propiedad (LOW | MEDIUM | HIGH)
// -----------------------------------------------------------------------------

model RiskAssessment {
  id         String   @id @default(uuid())
  propertyId String   @map("property_id")
  score      Int      // 0-100
  level      String   // LOW | MEDIUM | HIGH
  factorsJson Json?   @map("factors_json")
  updatedAt  DateTime @updatedAt @map("updated_at")

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("risk_assessments")
}

// -----------------------------------------------------------------------------
// Solicitud de arriendo/visita (booking sin pago en MVP)
// -----------------------------------------------------------------------------

model Booking {
  id         String   @id @default(uuid())
  propertyId String   @map("property_id")
  userId     String   @map("user_id") // solicitante (arrendatario/interesado)
  dateFrom   DateTime @map("date_from") @db.Date
  dateTo     DateTime @map("date_to") @db.Date
  note       String?  @db.Text
  status     String   @default("PENDING") // PENDING | CONFIRMED | COMPLETED | CANCELLED
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([userId])
  @@index([status])
  @@map("bookings")
}
